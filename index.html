<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map – 9:16 Mobile Ready</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; overflow: hidden; }
        #map { height: calc(100vh - 120px); width: 100%; }

        /* ---------- Search Bar ---------- */
        .search-container {
            position: absolute;
            top: 8px; left: 8px; right: 8px;
            z-index: 1000;
            background: white;
            padding: 6px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        .search-container input {
            flex: 1;
            min-width: 150px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-container button {
            padding: 8px 12px;
            background:#4CAF50;
            color:white;
            border:none;
            border-radius:4px;
            cursor:pointer;
            font-size: 14px;
        }
        .search-container button:hover { background:#45a049; }

        /* ---------- Gear Icon ---------- */
        .gear-icon {
            position: absolute;
            top: 8px; right: 8px;
            z-index: 1000;
            background:white;
            padding:8px;
            border-radius:6px;
            box-shadow:0 2px 6px rgba(0,0,0,0.2);
            cursor:pointer;
            font-size:20px;
            color:#333;
        }
        .gear-icon:hover { background:#f0f0f0; }

        /* ---------- Coordinates Label ---------- */
        .coords-label {
            position: absolute;
            top: 56px; left: 8px; right: 8px;
            z-index: 1000;
            background:white;
            padding:6px 10px;
            border-radius:6px;
            box-shadow:0 2px 6px rgba(0,0,0,0.2);
            font-size:13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ---------- Modal ---------- */
        .modal-overlay {
            display:none;
            position:fixed;
            inset:0;
            background:rgba(0,0,0,0.5);
            z-index:2000;
            align-items:center;
            justify-content:center;
            padding: 10px;
        }
        .modal-content {
            background:white;
            padding:20px;
            border-radius:8px;
            width:90vw;
            max-width:300px;
            text-align:center;
            box-shadow:0 4px 12px rgba(0,0,0,0.3);
        }
        .modal-content button {
            display:block;
            width:100%;
            margin:8px 0;
            padding:10px;
            background:#2196F3;
            color:white;
            border:none;
            border-radius:4px;
            cursor:pointer;
            font-size:14px;
        }
        .modal-content button:hover { background:#1976D2; }
        .modal-content button:disabled { background:#ccc; cursor:not-allowed; }
        .modal-content button.active { background:#FF5722; }
        .modal-content button.active:hover { background:#E64A19; }
        .modal-content .close-button,
        .modal-content .done-button { background:#f44336; }
        .modal-content .close-button:hover,
        .modal-content .done-button:hover { background:#d32f2f; }
        #doneButton { display:none; }

        /* ---------- Mobile (≤500px) – 9:16 Portrait ---------- */
        @media (max-width: 500px) {
            #map { height: calc(100vh - 140px); }

            .search-container {
                flex-direction: column;
                top: 8px; left: 8px; right: 8px;
            }
            .search-container input,
            .search-container button { width: 100%; }

            .gear-icon {
                top: auto;
                bottom: 70px;
                right: 8px;
            }

            .coords-label {
                top: auto;
                bottom: 8px;
                left: 8px;
                right: 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

    <!-- UI Elements -->
    <div class="search-container">
        <input type="text" id="search" placeholder="Search for a location...">
        <button id="searchButton">Confirm</button>
    </div>
    <div class="gear-icon" id="gearIcon"><i class="fas fa-gear"></i></div>
    <div class="coords-label" id="coords">Click on map to see coordinates</div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <button id="loadDevices">Load Devices from Firebase</button>
            <button id="addSampleDevice">Add Sample Device</button>
            <button id="createCircle">Create Circle</button>
            <button id="createPolyline">Create Polyline</button>
            <button id="loadCircles">Load Circles from Firebase</button>
            <button id="doneButton" class="done-button">Done</button>
            <button class="close-button" id="closeModal">Close</button>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet-Geosearch -->
    <script src="https://unpkg.com/leaflet-geosearch@3.10.1/dist/geosearch.umd.js"></script>

    <!-- Firebase + Map Logic -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBGONaynbM6GSdq4Ee46dD8tqfeCYx-w-M",
            authDomain: "probationlocator.firebaseapp.com",
            databaseURL: "https://probationlocator-default-rtdb.firebaseio.com",
            projectId: "probationlocator",
            storageBucket: "probationlocator.firebasestorage.app",
            messagingSenderId: "323066331183",
            appId: "1:323066331183:web:61f35b70cb07c0618106da"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        signInAnonymously(auth).catch(err => {
            console.error('Auth error:', err);
            alert('Firebase auth failed.');
        });

        // Initialize Map
        const map = L.map('map').setView([14.7724, 120.9600], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Icons
        const clickIcon = L.divIcon({
            className: 'custom-icon',
            html: '<div style="background:blue;width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>',
            iconSize: [12, 12], iconAnchor: [6, 6]
        });
        const deviceIcon = L.divIcon({
            className: 'custom-device-icon',
            html: '<div style="background:orange;width:16px;height:16px;border:2px solid white;border-radius:2px;"></div>',
            iconSize: [16, 16], iconAnchor: [8, 8]
        });

        // Layers
        let searchMarker = L.marker([14.7724, 120.9600]).addTo(map).bindPopup('Initial location').openPopup();
        let clickMarker = null;
        const deviceMarkers = L.layerGroup().addTo(map);
        const circleLayer = L.layerGroup().addTo(map);
        const polylineLayer = L.layerGroup().addTo(map);

        let circleMode = false, polylineMode = false;
        let centerPoint = null, previewCircle = null;
        let polylinePoints = [], previewPolyline = null;

        const provider = new GeoSearch.OpenStreetMapProvider();

        // Helper: Check if point is inside circle
        function isPointInCircle(pointLat, pointLng, centerLat, centerLng, radius) {
            const point = L.latLng(pointLat, pointLng);
            const center = L.latLng(centerLat, centerLng);
            return center.distanceTo(point) <= radius;
        }

        // Create dynamic circle popup with "Show List" button
        function createCirclePopup(id, centerLat, centerLng, radius, date) {
            const popup = L.DomUtil.create('div');

            const info = document.createElement('div');
            info.innerHTML = `
                <b>ID:</b> ${id}<br>
                <b>Center:</b> ${centerLat.toFixed(5)}, ${centerLng.toFixed(5)}<br>
                <b>Radius:</b> ${(radius/1000).toFixed(2)} km<br>
                <b>Date:</b> ${new Date(date).toLocaleString('en-US', { timeZone: 'Asia/Manila' })}
                <hr style="margin:8px 0;">
            `;
            popup.appendChild(info);

            const button = document.createElement('button');
            button.textContent = 'Show List';
            button.style.cssText = `
                width:100%; padding:8px; margin-top:6px;
                background:#2196F3; color:white; border:none;
                border-radius:4px; cursor:pointer; font-size:13px;
            `;
            button.onclick = async () => {
                button.disabled = true;
                button.textContent = 'Loading...';

                try {
                    const snap = await get(ref(database, 'devices'));
                    const devices = snap.val() || {};
                    const inside = [];

                    Object.keys(devices).forEach(devId => {
                        const d = devices[devId];
                        const dlat = parseFloat(d.latitude);
                        const dlng = parseFloat(d.longitude);
                        if (!isNaN(dlat) && !isNaN(dlng)) {
                            if (isPointInCircle(dlat, dlng, centerLat, centerLng, radius)) {
                                const dateStr = d.date ? new Date(d.date).toLocaleString('en-US', { timeZone: 'Asia/Manila' }) : 'N/A';
                                inside.push(`
                                    <div style="margin:4px 0; padding:6px; background:#f9f9f9; border-radius:4px; font-size:12px;">
                                        <b>${devId}</b><br>
                                        <b>Pos:</b> ${dlat.toFixed(5)}, ${dlng.toFixed(5)}<br>
                                        <b>Status:</b> ${d.status || 'N/A'}<br>
                                        <b>Date:</b> ${dateStr}
                                    </div>
                                `);
                            }
                        }
                    });

                    if (inside.length > 0) {
                        popup.innerHTML = `<b>${inside.length} Device(s) Inside:</b><hr style="margin:8px 0;">` + inside.join('');
                    } else {
                        popup.innerHTML = `<b>No devices inside this circle.</b>`;
                    }
                } catch (err) {
                    popup.innerHTML += `<div style="color:red; margin-top:8px;">Error loading devices.</div>`;
                } finally {
                    button.remove();
                }
            };

            popup.appendChild(button);
            return popup;
        }

        // Modal
        function toggleModal() {
            const overlay = document.getElementById('modalOverlay');
            overlay.style.display = overlay.style.display === 'block' ? 'none' : 'block';
        }
        function toggleDoneButton(show) {
            document.getElementById('doneButton').style.display = show ? 'block' : 'none';
        }

        // Search
        async function searchLocation() {
            const query = document.getElementById('search').value.trim();
            if (!query) return;
            try {
                const results = await provider.search({ query });
                if (results.length > 0) {
                    const { x, y, label } = results[0];
                    map.setView([y, x], 13);
                    searchMarker.setLatLng([y, x]).setPopupContent(label).openPopup();
                } else {
                    alert('Location not found.');
                }
            } catch (e) {
                alert('Search error.');
            }
        }

        // Load Devices
        async function loadDevices() {
            const btn = document.getElementById('loadDevices');
            btn.disabled = true; btn.innerText = 'Loading...';
            deviceMarkers.clearLayers();
            try {
                const snap = await get(ref(database, 'devices'));
                const data = snap.val();
                if (!data) { alert('No devices.'); return; }
                Object.keys(data).forEach(id => {
                    const d = data[id];
                    if (d.latitude && d.longitude) {
                        const lat = parseFloat(d.latitude), lng = parseFloat(d.longitude);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            const date = d.date ? new Date(d.date).toLocaleString('en-US', { timeZone: 'Asia/Manila' }) : 'N/A';
                            L.marker([lat, lng], { icon: deviceIcon }).addTo(deviceMarkers)
                                .bindPopup(`<b>ID:</b> ${id}<br><b>Lat:</b> ${lat.toFixed(5)}<br><b>Lng:</b> ${lng.toFixed(5)}<br><b>Date:</b> ${date}<br><b>Status:</b> ${d.status || 'N/A'}`);
                        }
                    }
                });
                if (deviceMarkers.getLayers().length > 0) map.fitBounds(deviceMarkers.getBounds(), { padding: [20, 20] });
                btn.innerText = `Loaded ${deviceMarkers.getLayers().length}`;
            } catch (e) { alert('Load error.'); } finally {
                btn.disabled = false;
                setTimeout(() => btn.innerText = 'Load Devices from Firebase', 3000);
                toggleModal();
            }
        }

        // Add Sample Device
        async function addSampleDevice() {
            const btn = document.getElementById('addSampleDevice');
            btn.disabled = true; btn.innerText = 'Adding...';
            try {
                const id = 'device_' + Math.random().toString(36).substr(2, 6);
                const lat = 14.7724 + (Math.random() * 0.02 - 0.01);
                const lng = 120.9600 + (Math.random() * 0.02 - 0.01);
                const date = new Date().toISOString();
                const status = ['Active', 'Inactive', 'Offline'][Math.floor(Math.random() * 3)];
                await set(ref(database, 'devices/' + id), { latitude: lat, longitude: lng, date, status });
                const marker = L.marker([lat, lng], { icon: deviceIcon }).addTo(deviceMarkers)
                    .bindPopup(`<b>ID:</b> ${id}<br><b>Lat:</b> ${lat.toFixed(5)}<br><b>Lng:</b> ${lng.toFixed(5)}<br><b>Date:</b> ${new Date(date).toLocaleString('en-US', { timeZone: 'Asia/Manila' })}<br><b>Status:</b> ${status}`)
                    .openPopup();
                map.setView([lat, lng], 13);
                btn.innerText = 'Added!';
            } catch (e) { alert('Add error.'); } finally {
                btn.disabled = false;
                setTimeout(() => btn.innerText = 'Add Sample Device', 3000);
                toggleModal();
            }
        }

        // Circle Mode
        function toggleCircleMode() {
            circleMode = !circleMode;
            const btn = document.getElementById('createCircle');
            if (circleMode) {
                btn.classList.add('active'); btn.innerText = 'Click center';
                document.getElementById('coords').innerText = 'Click to set circle center';
            } else {
                btn.classList.remove('active'); btn.innerText = 'Create Circle';
                document.getElementById('coords').innerText = 'Click on map to see coordinates';
                centerPoint = null;
                if (previewCircle) map.removeLayer(previewCircle); previewCircle = null;
                map.off('mousemove');
            }
            toggleModal();
        }

        // Polyline Mode
        function togglePolylineMode() {
            polylineMode = !polylineMode;
            const btn = document.getElementById('createPolyline');
            if (polylineMode) {
                btn.classList.add('active'); btn.innerText = 'Creating...';
                document.getElementById('coords').innerText = 'Click to add point';
                polylinePoints = [];
                toggleDoneButton(true);
                if (previewPolyline) map.removeLayer(previewPolyline); previewPolyline = null;
            } else {
                btn.classList.remove('active'); btn.innerText = 'Create Polyline';
                document.getElementById('coords').innerText = 'Click on map to see coordinates';
                polylinePoints = [];
                toggleDoneButton(false);
                if (previewPolyline) map.removeLayer(previewPolyline); previewPolyline = null;
            }
            toggleModal();
        }

        // Finish Polyline
        async function finishPolyline() {
            if (polylinePoints.length < 3) { alert('Need 3+ points.'); return; }
            const id = 'polyline_' + Math.random().toString(36).substr(2, 6);
            const date = new Date().toISOString();
            try {
                await set(ref(database, 'polylines'), {});
                await set(ref(database, 'polylines/' + id), { points: polylinePoints.map(p => ({ lat: p.lat, lng: p.lng })), date });
                if (previewPolyline) map.removeLayer(previewPolyline);
                polylineLayer.clearLayers();
                const polygon = L.polygon(polylinePoints, { color: '#FF5722', fillOpacity: 0.05, weight: 2 }).addTo(polylineLayer)
                    .bindPopup(`<b>ID:</b> ${id}<br><b>Points:</b> ${polylinePoints.length}<br><b>Date:</b> ${new Date(date).toLocaleString('en-US', { timeZone: 'Asia/Manila' })}`)
                    .openPopup();
                map.fitBounds(polygon.getBounds(), { padding: [20, 20] });
                polylineMode = false;
                document.getElementById('createPolyline').classList.remove('active');
                document.getElementById('createPolyline').innerText = 'Create Polyline';
                document.getElementById('coords').innerText = 'Click on map to see coordinates';
                polylinePoints = [];
                toggleDoneButton(false);
            } catch (e) { alert('Save error.'); }
            toggleModal();
        }

        // Load Circles
        async function loadCircles() {
            const btn = document.getElementById('loadCircles');
            btn.disabled = true; btn.innerText = 'Loading...';
            circleLayer.clearLayers();
            try {
                const snap = await get(ref(database, 'circles'));
                const data = snap.val();
                if (!data) { alert('No circles.'); return; }
                Object.keys(data).forEach(id => {
                    const c = data[id];
                    if (c.latitude && c.longitude && c.radius) {
                        const lat = parseFloat(c.latitude), lng = parseFloat(c.longitude), radius = parseFloat(c.radius);
                        if (!isNaN(lat) && !isNaN(lng) && !isNaN(radius)) {
                            const date = c.date ? c.date : new Date().toISOString();
                            L.circle([lat, lng], { radius, color: '#FF5722', fillOpacity: 0.05, weight: 2 })
                                .addTo(circleLayer)
                                .bindPopup(() => createCirclePopup(id, lat, lng, radius, date));
                        }
                    }
                });
                if (circleLayer.getLayers().length > 0) map.fitBounds(circleLayer.getBounds(), { padding: [20, 20] });
                btn.innerText = `Loaded ${circleLayer.getLayers().length}`;
            } catch (e) { alert('Load error.'); } finally {
                btn.disabled = false;
                setTimeout(() => btn.innerText = 'Load Circles from Firebase', 3000);
                toggleModal();
            }
        }

        // Map Click
        map.on('click', async e => {
            const lat = e.latlng.lat.toFixed(5), lng = e.latlng.lng.toFixed(5);
            if (circleMode) {
                if (!centerPoint) {
                    centerPoint = e.latlng;
                    circleLayer.clearLayers();
                    document.getElementById('coords').innerText = 'Move to set radius';
                    if (clickMarker) map.removeLayer(clickMarker);
                    map.on('mousemove', moveE => {
                        if (!centerPoint) return;
                        const r = centerPoint.distanceTo(moveE.latlng);
                        if (previewCircle) map.removeLayer(previewCircle);
                        previewCircle = L.circle(centerPoint, { radius: r, color: '#FF5722', fillOpacity: 0.05, weight: 2, dashArray: '5,10' }).addTo(map);
                        document.getElementById('coords').innerText = `Radius: ${(r/1000).toFixed(2)} km`;
                    });
                } else {
                    const radius = centerPoint.distanceTo(e.latlng);
                    const date = new Date().toISOString();
                    const id = 'circle_' + Math.random().toString(36).substr(2, 6);
                    if (previewCircle) map.removeLayer(previewCircle);
                    map.off('mousemove');
                    try {
                        await set(ref(database, 'circles'), {});
                        await set(ref(database, 'circles/' + id), { latitude: centerPoint.lat, longitude: centerPoint.lng, radius, date });
                        circleLayer.clearLayers();
                        L.circle(centerPoint, { radius, color: '#FF5722', fillOpacity: 0.05, weight: 2 })
                            .addTo(circleLayer)
                            .bindPopup(() => createCirclePopup(id, centerPoint.lat, centerPoint.lng, radius, date))
                            .openPopup();
                        map.setView(centerPoint, 13);
                    } catch (e) { alert('Save error.'); }
                    toggleCircleMode();
                }
            } else if (polylineMode) {
                polylinePoints.push(e.latlng);
                document.getElementById('coords').innerText = `Point ${polylinePoints.length}: ${lat}, ${lng}`;
                if (previewPolyline) map.removeLayer(previewPolyline);
                previewPolyline = L.polyline(polylinePoints, { color: '#FF5722', weight: 2 }).addTo(map);
                if (clickMarker) map.removeLayer(clickMarker);
            } else {
                document.getElementById('coords').innerText = `Lat: ${lat}, Lng: ${lng}`;
                if (clickMarker) map.removeLayer(clickMarker);
                clickMarker = L.marker(e.latlng, { icon: clickIcon }).addTo(map)
                    .bindPopup(`Clicked<br>Lat: ${lat}, Lng: ${lng}`).openPopup();
            }
        });

        // Event Listeners
        document.getElementById('search').addEventListener('keypress', e => e.key === 'Enter' && searchLocation());
        document.getElementById('searchButton').addEventListener('click', searchLocation);
        document.getElementById('loadDevices').addEventListener('click', loadDevices);
        document.getElementById('addSampleDevice').addEventListener('click', addSampleDevice);
        document.getElementById('createCircle').addEventListener('click', toggleCircleMode);
        document.getElementById('createPolyline').addEventListener('click', togglePolylineMode);
        document.getElementById('loadCircles').addEventListener('click', loadCircles);
        document.getElementById('doneButton').addEventListener('click', finishPolyline);
        document.getElementById('gearIcon').addEventListener('click', toggleModal);
        document.getElementById('closeModal').addEventListener('click', toggleModal);
        document.getElementById('modalOverlay').addEventListener('click', e => e.target === e.currentTarget && toggleModal());
    </script>
</body>
</html>
